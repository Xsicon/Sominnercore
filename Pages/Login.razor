@page "/admin/login"
@using Sominnercore.Layout
@layout AuthLayout
@using Sominnercore.Services
@using Sominnercore.Models
@using System.ComponentModel.DataAnnotations
@using System.Text.Json
@using System.Net.Http
@inject SupabaseAuthService AuthService
@inject IJSRuntime JsRuntime
@inject NavigationManager Navigation

<div class="login-page">
    <div class="login-card">
        <div class="login-card-header">
            <div class="login-card-icon">
                <i class="login-lock-icon" aria-hidden="true"></i>
            </div>
            <h1 class="login-title">Sign in to access the admin dashboard</h1>
        </div>

        <EditForm Model="_loginModel" OnValidSubmit="HandleLoginAsync">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="login-field">
                <label for="role">Role</label>
                <select id="role" class="login-input" @bind-Value="SelectedRole" @bind-Value:event="onchange">
                    <option value="">Select your role</option>
                    @foreach (var role in _demoCredentials.Keys)
                    {
                        <option value="@role">@role</option>
                    }
                </select>
            </div>

            @if (TryGetSelectedCredential(out var credentialPreview))
            {
                <div class="login-demo-preview">
                    <div class="login-demo-row">
                        <span class="login-demo-label">Email:</span>
                        <span class="login-demo-value">@credentialPreview.Email</span>
                    </div>
                    <div class="login-demo-row">
                        <span class="login-demo-label">Password:</span>
                        <span class="login-demo-value">@credentialPreview.Password</span>
                    </div>
                </div>
            }

            <div class="login-field">
                <label for="email">Email</label>
                <InputText id="email" class="login-input" @bind-Value="_loginModel.Email" placeholder="Enter your email or username" />
                <ValidationMessage For="@(() => _loginModel.Email)" />
            </div>

            <div class="login-field">
                <label for="password">Password</label>
                <InputText id="password" class="login-input" @bind-Value="_loginModel.Password" placeholder="Enter your password" type="password" />
                <ValidationMessage For="@(() => _loginModel.Password)" />
            </div>

            @if (!string.IsNullOrWhiteSpace(_errorMessage))
            {
                <div class="login-alert error">
                    @_errorMessage
                </div>
            }

            @if (!string.IsNullOrWhiteSpace(_successMessage))
            {
                <div class="login-alert success">
                    @_successMessage
                </div>
            }

            <button class="login-submit-button" type="submit" disabled="@_isSubmitting">
                @_buttonLabel
            </button>
        </EditForm>
    </div>
</div>

@code {
    private readonly LoginInputModel _loginModel = new();
    private readonly Dictionary<string, (string Email, string Password)> _demoCredentials = new(StringComparer.OrdinalIgnoreCase)
    {
        { "Admin", ("admin@sominercore.com", "admin123") },
        { "Marketing Manager", ("marketing@sominercore.com", "marketing123") },
        { "CRS", ("crs@sominercore.com", "crs123") },
        { "Support Specialist", ("support@sominercore.com", "support123") },
        { "Developer", ("dev@sominercore.com", "dev123") }
    };

    private string? _selectedRole;
    private bool _isSubmitting;
    private string? _errorMessage;
    private string? _successMessage;
    private string _buttonLabel => _isSubmitting ? "Signing In..." : "Sign In";

    private async Task HandleLoginAsync()
    {
        _errorMessage = null;
        _successMessage = null;
        _isSubmitting = true;

        try
        {
            var result = await AuthService.SignInAsync(_loginModel.Email, _loginModel.Password);

            await JsRuntime.InvokeVoidAsync("localStorage.setItem", "sb-access-token", result.AccessToken);
            if (!string.IsNullOrWhiteSpace(result.RefreshToken))
            {
                await JsRuntime.InvokeVoidAsync("localStorage.setItem", "sb-refresh-token", result.RefreshToken);
            }

            _successMessage = $"Welcome back{(result.User?.Email is not null ? $", {result.User.Email}" : string.Empty)}!";
            Navigation.NavigateTo("/admin", forceLoad: false);
        }
        catch (SupabaseAuthException ex)
        {
            _errorMessage = $"Sign in failed ({(int)ex.StatusCode}): {ParseSupabaseError(ex.Message)}";
        }
        catch (HttpRequestException)
        {
            _errorMessage = "Network error while contacting Supabase. Verify your Supabase URL and network connectivity.";
        }
        catch (InvalidOperationException ex)
        {
            _errorMessage = ex.Message;
        }
        catch (Exception ex)
        {
            _errorMessage = $"Unexpected error: {ex.Message}";
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private string? SelectedRole
    {
        get => _selectedRole;
        set
        {
            _selectedRole = string.IsNullOrWhiteSpace(value) ? null : value;
            ApplySelectedRole(_selectedRole);
            StateHasChanged();
        }
    }

    private void ApplySelectedRole(string? role)
    {
        _successMessage = null;
        _errorMessage = null;

        if (!string.IsNullOrWhiteSpace(role) && _demoCredentials.TryGetValue(role, out var credential))
        {
            _loginModel.Email = credential.Email;
            _loginModel.Password = credential.Password;
        }
    }

    private bool TryGetSelectedCredential(out (string Email, string Password) credential)
    {
        if (!string.IsNullOrWhiteSpace(_selectedRole) &&
            _demoCredentials.TryGetValue(_selectedRole, out var value))
        {
            credential = value;
            return true;
        }

        credential = default;
        return false;
    }

    private static string ParseSupabaseError(string responseContent)
    {
        try
        {
            var json = JsonSerializer.Deserialize<Dictionary<string, object>>(responseContent);
            if (json is not null)
            {
                if (json.TryGetValue("error_description", out var description) && description is not null)
                {
                    return description.ToString() ?? "Check your credentials and try again.";
                }

                if (json.TryGetValue("message", out var message) && message is not null)
                {
                    return message.ToString() ?? "Check your credentials and try again.";
                }
            }
        }
        catch
        {
            // ignored â€“ fall back to default message
        }

        return "Check your credentials and try again.";
    }

    private class LoginInputModel
    {
        [Required(ErrorMessage = "Email is required.")]
        [EmailAddress(ErrorMessage = "Enter a valid email address.")]
        public string Email { get; set; } = string.Empty;

        [Required(ErrorMessage = "Password is required.")]
        public string Password { get; set; } = string.Empty;
    }
}

