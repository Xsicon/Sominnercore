@page "/admin/backend-chat"
@layout Sominnercore.Layout.AdminLayout
@using System.Globalization
@using System.Linq
@using System.Collections.Generic

<DashboardHeader Title="Customer Support Chat"
                 Subtitle="Respond to customer inquiries in real-time" />

<div class="backend-chat-page">
    <div class="backend-chat-layout">
        <aside class="chat-conversations-panel">
            <div class="chat-panel-header">
                <h2>Conversations</h2>
                <span class="chat-unread-pill">@TotalUnreadCount Unread</span>
            </div>

            <div class="chat-search">
                <MudIcon Icon="@Icons.Material.Filled.Search" Class="chat-search-icon" />
                <input class="chat-search-input"
                       placeholder="Search conversations..."
                       @bind="_searchTerm"
                       @bind:event="oninput" />
            </div>

            <div class="chat-conversation-list">
                @{
                    var visibleConversations = FilteredConversations.ToList();
                }

                @if (visibleConversations.Count == 0)
                {
                    <div class="chat-conversation-empty">
                        <MudIcon Icon="@Icons.Material.Filled.ChatBubbleOutline" />
                        <p>No conversations found.</p>
                    </div>
                }
                else
                {
                    @foreach (var conversation in visibleConversations)
                    {
                        var isSelected = conversation.Id == _selectedConversationId;
                        var statusInfo = GetStatusInfo(conversation.Status);

                        <article class="chat-conversation-item @(isSelected ? "selected" : string.Empty)"
                                 @onclick="() => SelectConversation(conversation.Id)">
                            <div class="chat-avatar" style="background: @conversation.AvatarGradient">
                                @conversation.Initials
                            </div>
                            <div class="chat-conversation-body">
                                <header>
                                    <div>
                                        <h3>@conversation.Name</h3>
                                        <span class="chat-email">@conversation.Email</span>
                                    </div>
                                    <div class="chat-conversation-meta">
                                        <span class="chat-conversation-date">@conversation.LastMessageAt.ToString("MMM d", CultureInfo.InvariantCulture)</span>
                                        @if (conversation.UnreadCount > 0)
                                        {
                                            <span class="chat-unread-badge">@conversation.UnreadCount</span>
                                        }
                                    </div>
                                </header>
                                <p class="chat-preview">@conversation.LastMessagePreview</p>
                                <div class="chat-status">
                                    <span class="chat-status-dot @statusInfo.CssClass"></span>
                                    <span class="chat-status-label">@statusInfo.Label</span>
                                </div>
                            </div>
                        </article>
                    }
                }
            </div>
        </aside>

        <section class="chat-thread-panel">
            @if (CurrentConversation is null)
            {
                <div class="chat-preview-empty">
                    <MudIcon Icon="@Icons.Material.Filled.Forum" />
                    <h3>Select a conversation to view messages</h3>
                    <p>The message thread will appear here once a conversation is selected.</p>
                </div>
            }
            else
            {
                <header class="chat-thread-header">
                    <div class="chat-thread-meta">
                        <div class="chat-avatar large" style="background: @CurrentConversation.AvatarGradient">
                            @CurrentConversation.Initials
                        </div>
                        <div class="chat-thread-contact">
                            <h2>@CurrentConversation.Name</h2>
                            <span>@CurrentConversation.Email</span>
                        </div>
                    </div>
                    <div class="chat-thread-actions">
                        <MudIconButton Icon="@Icons.Material.Filled.Call" Class="chat-thread-action" Disabled="true" />
                        <MudIconButton Icon="@Icons.Material.Filled.Videocam" Class="chat-thread-action" Disabled="true" />
                        <MudIconButton Icon="@Icons.Material.Filled.MoreVert" Class="chat-thread-action" Disabled="true" />
                    </div>
                </header>

                <div class="chat-thread-body">
                    @foreach (var message in CurrentMessages)
                    {
                        var bubbleClass = message.Direction == MessageDirection.Outgoing
                            ? "chat-message outgoing"
                            : "chat-message incoming";

                        <div class="@bubbleClass">
                            <div class="chat-message-content">@message.Content</div>
                            <span class="chat-message-time">@message.SentAt.ToString("hh:mm tt", CultureInfo.InvariantCulture)</span>
                        </div>
                    }
                </div>

                <footer class="chat-thread-composer">
                    <div class="chat-composer-input">
                        <MudIcon Icon="@Icons.Material.Filled.AttachFile" Class="chat-composer-icon" />
                        <MudIcon Icon="@Icons.Material.Filled.TagFaces" Class="chat-composer-icon" />
                        <input @bind="_draftMessage"
                               @bind:event="oninput"
                               placeholder="Type your message..." />
                    </div>
                    <MudIconButton Icon="@Icons.Material.Filled.Send"
                                   Class="chat-send-button"
                                   OnClick="SendDraftAsync" />
                </footer>

                <div class="chat-thread-footer-note">
                    Responding as <strong>@_currentAgentName</strong>
                </div>
            }
        </section>
    </div>
</div>

@code {
    private const string DefaultAvatarGradient = "linear-gradient(135deg, #22d3ee, #f97316)";

    private readonly IReadOnlyList<ConversationSummary> _conversations = new List<ConversationSummary>
    {
        new(
            Guid.NewGuid(),
            "Alex Thompson",
            "alex.t@company.com",
            "Thanks for the quick response!",
            ConversationStatus.Active,
            2,
            new DateTime(2025, 11, 7, 17, 30, 0),
            DefaultAvatarGradient),
        new(
            Guid.NewGuid(),
            "Maria Garcia",
            "maria.g@startup.io",
            "When can we schedule a call?",
            ConversationStatus.Waiting,
            1,
            new DateTime(2025, 11, 7, 15, 10, 0),
            DefaultAvatarGradient),
        new(
            Guid.NewGuid(),
            "Robert Kim",
            "robert.k@enterprise.com",
            "Perfect, thank you for your help!",
            ConversationStatus.Resolved,
            0,
            new DateTime(2025, 11, 6, 18, 45, 0),
            DefaultAvatarGradient),
        new(
            Guid.NewGuid(),
            "Priya Patel",
            "priya.p@nextgen.ai",
            "Our CTO would like to review a proposal.",
            ConversationStatus.Waiting,
            0,
            new DateTime(2025, 11, 5, 11, 20, 0),
            DefaultAvatarGradient)
    };

    private Guid _selectedConversationId;
    private string _searchTerm = string.Empty;
    private string _draftMessage = string.Empty;
    private string _currentAgentName = "Admin User (Admin)";

    protected override void OnInitialized()
    {
        _selectedConversationId = _conversations.First().Id;
    }

    private IEnumerable<ConversationSummary> FilteredConversations =>
        string.IsNullOrWhiteSpace(_searchTerm)
            ? _conversations
            : _conversations.Where(conversation =>
                conversation.Name.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
                conversation.Email.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
                conversation.LastMessagePreview.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase));

    private int TotalUnreadCount => _conversations.Sum(c => c.UnreadCount);

    private void SelectConversation(Guid conversationId)
    {
        _selectedConversationId = conversationId;
    }

    private ConversationSummary? CurrentConversation =>
        _conversations.FirstOrDefault(c => c.Id == _selectedConversationId);

    private IEnumerable<ChatMessage> CurrentMessages =>
        _messages.TryGetValue(_selectedConversationId, out var list) ? list : Enumerable.Empty<ChatMessage>();

    private Task SendDraftAsync()
    {
        if (string.IsNullOrWhiteSpace(_draftMessage) || !_messages.TryGetValue(_selectedConversationId, out var list))
        {
            return Task.CompletedTask;
        }

        list.Add(new ChatMessage(_selectedConversationId, _draftMessage.Trim(), DateTime.Now, MessageDirection.Outgoing));
        _draftMessage = string.Empty;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private static (string Label, string CssClass) GetStatusInfo(ConversationStatus status) =>
        status switch
        {
            ConversationStatus.Active => ("Active", "status-active"),
            ConversationStatus.Waiting => ("Waiting", "status-waiting"),
            ConversationStatus.Resolved => ("Resolved", "status-resolved"),
            _ => ("New", "status-active")
        };

    private record ConversationSummary(
        Guid Id,
        string Name,
        string Email,
        string LastMessagePreview,
        ConversationStatus Status,
        int UnreadCount,
        DateTime LastMessageAt,
        string AvatarGradient)
    {
        public string Initials => string.Join(string.Empty, Name.Split(' ', StringSplitOptions.RemoveEmptyEntries)
            .Take(2)
            .Select(part => char.ToUpperInvariant(part[0])));
    }

    private readonly Dictionary<Guid, List<ChatMessage>> _messages;

    private record ChatMessage(Guid ConversationId, string Content, DateTime SentAt, MessageDirection Direction);

    private enum MessageDirection
    {
        Incoming,
        Outgoing
    }


    public BackendChat()
    {
        _messages = new Dictionary<Guid, List<ChatMessage>>
        {
            [_conversations[0].Id] = new List<ChatMessage>
            {
                new(_conversations[0].Id, "I need a platform that can handle around 5,000 products with payment integration, inventory management, and customer reviews.", new DateTime(2025, 11, 7, 17, 25, 0), MessageDirection.Incoming),
                new(_conversations[0].Id, "Thanks for the quick response!", new DateTime(2025, 11, 7, 17, 30, 0), MessageDirection.Incoming),
                new(_conversations[0].Id, "Happy to help! We’ll follow up with a tailored proposal shortly.", new DateTime(2025, 11, 7, 17, 35, 0), MessageDirection.Outgoing)
            },
            [_conversations[1].Id] = new List<ChatMessage>
            {
                new(_conversations[1].Id, "When can we schedule a call to walk through the onboarding steps?", new DateTime(2025, 11, 7, 15, 10, 0), MessageDirection.Incoming),
                new(_conversations[1].Id, "I’m available tomorrow at 10 AM EST if that works.", new DateTime(2025, 11, 7, 15, 18, 0), MessageDirection.Outgoing)
            },
            [_conversations[2].Id] = new List<ChatMessage>
            {
                new(_conversations[2].Id, "Perfect, thank you for your help!", new DateTime(2025, 11, 6, 18, 45, 0), MessageDirection.Incoming),
                new(_conversations[2].Id, "Glad we could resolve it. Let us know if anything else comes up.", new DateTime(2025, 11, 6, 18, 47, 0), MessageDirection.Outgoing)
            },
            [_conversations[3].Id] = new List<ChatMessage>
            {
                new(_conversations[3].Id, "Our CTO would like to review a proposal.", new DateTime(2025, 11, 5, 11, 20, 0), MessageDirection.Incoming),
                new(_conversations[3].Id, "Absolutely—we’ll share a detailed plan later today.", new DateTime(2025, 11, 5, 11, 34, 0), MessageDirection.Outgoing)
            }
        };
    }

    private enum ConversationStatus
    {
        Active,
        Waiting,
        Resolved
    }
}

